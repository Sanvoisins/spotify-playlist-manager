<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Playlist Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            -webkit-app-region: drag;
        }
        button, input, a, #app {
            -webkit-app-region: no-drag;
        }
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <script src="renderer.js"></script>
</body>
</html>-drag {
            -webkit-app-region: no-drag;
        }
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { Music, Search, CheckSquare, Square, Copy, ExternalLink, Loader, ChevronRight } = lucide;

        const SpotifyPlaylistManager = () => {
          const [view, setView] = React.useState('auth');
          const [spotifyToken, setSpotifyToken] = React.useState(null);
          const [spotifyUser, setSpotifyUser] = React.useState(null);
          const [playlists, setPlaylists] = React.useState([]);
          const [selectedPlaylist, setSelectedPlaylist] = React.useState(null);
          const [tracks, setTracks] = React.useState([]);
          const [selectedTracks, setSelectedTracks] = React.useState(new Set());
          const [searchQuery, setSearchQuery] = React.useState('');
          const [loading, setLoading] = React.useState(false);
          const [createdPlaylistUrl, setCreatedPlaylistUrl] = React.useState(null);
          const [newPlaylistName, setNewPlaylistName] = React.useState('');
          const [isPublic, setIsPublic] = React.useState(false);
          const [progress, setProgress] = React.useState({ current: 0, total: 0 });
          const [tokenExpiry, setTokenExpiry] = React.useState(null);

          // Configuration charg√©e depuis le fichier .env
          const [config, setConfig] = React.useState({ clientId: '', redirectUri: '' });
          const SCOPES = 'playlist-read-private playlist-modify-public playlist-modify-private';

          // Charger la configuration depuis le serveur
          React.useEffect(() => {
            fetch('http://127.0.0.1:8888/config')
              .then(res => res.json())
              .then(data => {
                setConfig({ clientId: data.clientId, redirectUri: data.redirectUri });
              })
              .catch(err => console.error('Erreur chargement config:', err));
          }, []);

          React.useEffect(() => {
            const savedToken = localStorage.getItem('spotify_token');
            const savedUser = localStorage.getItem('spotify_user');
            const savedExpiry = localStorage.getItem('token_expiry');
            
            if (savedToken && savedUser && savedExpiry) {
              const expiryTime = parseInt(savedExpiry);
              if (Date.now() < expiryTime) {
                setSpotifyToken(savedToken);
                setSpotifyUser(JSON.parse(savedUser));
                setTokenExpiry(expiryTime);
                setView('playlists');
                
                const timeUntilRefresh = expiryTime - Date.now() - (5 * 60 * 1000);
                if (timeUntilRefresh > 0) {
                  setTimeout(() => {
                    handleTokenExpiration();
                  }, timeUntilRefresh);
                }
              } else {
                clearSession();
              }
            }
            
            handleSpotifyCallback();
            
            // √âcouter les changements de hash pour OAuth
            window.addEventListener('hashchange', handleSpotifyCallback);
            return () => window.removeEventListener('hashchange', handleSpotifyCallback);
          }, []);

          const handleSpotifyCallback = () => {
            const hash = window.location.hash;
            if (hash) {
              const params = new URLSearchParams(hash.substring(1));
              const token = params.get('access_token');
              const expiresIn = params.get('expires_in');
              
              if (token) {
                const expiryTime = Date.now() + (parseInt(expiresIn) * 1000);
                setSpotifyToken(token);
                setTokenExpiry(expiryTime);
                localStorage.setItem('spotify_token', token);
                localStorage.setItem('token_expiry', expiryTime.toString());
                window.location.hash = '';
                fetchSpotifyUser(token);
                
                const timeUntilRefresh = (parseInt(expiresIn) - 300) * 1000;
                setTimeout(() => {
                  handleTokenExpiration();
                }, timeUntilRefresh);
              }
            }
          };
          
          const clearSession = () => {
            localStorage.removeItem('spotify_token');
            localStorage.removeItem('spotify_user');
            localStorage.removeItem('token_expiry');
            setSpotifyToken(null);
            setSpotifyUser(null);
            setTokenExpiry(null);
            setView('auth');
          };
          
          const handleTokenExpiration = () => {
            alert('Votre session a expir√©. Veuillez vous reconnecter.');
            clearSession();
          };

          const connectSpotify = () => {
            const authUrl = `https://accounts.spotify.com/authorize?client_id=${config.clientId}&response_type=token&redirect_uri=${encodeURIComponent(config.redirectUri)}&scope=${encodeURIComponent(SCOPES)}&show_dialog=true`;

            // Ouvrir dans le navigateur syst√®me
            window.open(authUrl, '_blank');
            
            // D√©marrer un serveur local pour capturer la r√©ponse
            startLocalServer();
          };

          const startLocalServer = () => {
            // Note: Dans Electron, on utilise un serveur local pour capturer le callback
            // Pour simplifier, on demande √† l'utilisateur de coller le lien
            setTimeout(() => {
              const urlFromUser = prompt(
                'Apr√®s autorisation, Spotify vous redirigera vers une page.\n' +
                'Copiez l\'URL compl√®te de cette page et collez-la ici:'
              );
              
              if (urlFromUser) {
                const hash = urlFromUser.split('#')[1];
                if (hash) {
                  window.location.hash = '#' + hash;
                  handleSpotifyCallback();
                }
              }
            }, 1000);
          };

          const fetchSpotifyUser = async (token) => {
            try {
              const response = await fetch('https://api.spotify.com/v1/me', {
                headers: { 'Authorization': `Bearer ${token}` }
              });
              const user = await response.json();
              setSpotifyUser(user);
              localStorage.setItem('spotify_user', JSON.stringify(user));
              setView('playlists');
              fetchPlaylists(token);
            } catch (error) {
              console.error('Erreur r√©cup√©ration utilisateur:', error);
            }
          };

          const fetchPlaylists = async (token) => {
            setLoading(true);
            try {
              let allPlaylists = [];
              let url = 'https://api.spotify.com/v1/me/playlists?limit=50';
              
              while (url) {
                const response = await fetch(url, {
                  headers: { 'Authorization': `Bearer ${token || spotifyToken}` }
                });
                
                if (response.status === 401) {
                  handleTokenExpiration();
                  return;
                }
                
                const data = await response.json();
                allPlaylists = [...allPlaylists, ...data.items];
                url = data.next;
              }
              
              setPlaylists(allPlaylists);
            } catch (error) {
              console.error('Erreur r√©cup√©ration playlists:', error);
            } finally {
              setLoading(false);
            }
          };

          const selectPlaylist = async (playlist) => {
            setSelectedPlaylist(playlist);
            setLoading(true);
            setView('tracks');
            
            try {
              let allTracks = [];
              let url = `https://api.spotify.com/v1/playlists/${playlist.id}/tracks`;
              
              while (url) {
                const response = await fetch(url, {
                  headers: { 'Authorization': `Bearer ${spotifyToken}` }
                });
                
                if (response.status === 401) {
                  handleTokenExpiration();
                  return;
                }
                
                const data = await response.json();
                allTracks = [...allTracks, ...data.items.filter(item => item.track)];
                url = data.next;
              }
              
              setTracks(allTracks);
              setSelectedTracks(new Set());
              
              const today = new Date().toISOString().split('T')[0];
              setNewPlaylistName(`New - ${playlist.name} - ${today}`);
            } catch (error) {
              console.error('Erreur r√©cup√©ration pistes:', error);
            } finally {
              setLoading(false);
            }
          };

          const toggleTrack = (trackId) => {
            const newSelected = new Set(selectedTracks);
            if (newSelected.has(trackId)) {
              newSelected.delete(trackId);
            } else {
              newSelected.add(trackId);
            }
            setSelectedTracks(newSelected);
          };

          const toggleAllTracks = () => {
            if (selectedTracks.size === tracks.length) {
              setSelectedTracks(new Set());
            } else {
              setSelectedTracks(new Set(tracks.map(t => t.track.id)));
            }
          };

          const createNewPlaylist = async () => {
            if (selectedTracks.size === 0) return;
            
            setView('creating');
            setProgress({ current: 0, total: selectedTracks.size });
            
            try {
              const createResponse = await fetch(`https://api.spotify.com/v1/users/${spotifyUser.id}/playlists`, {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${spotifyToken}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  name: newPlaylistName,
                  description: `Cr√©√©e depuis ${selectedPlaylist.name}`,
                  public: isPublic
                })
              });
              
              const playlist = await createResponse.json();
              
              const selectedTrackObjects = tracks.filter(t => selectedTracks.has(t.track.id));
              const uris = selectedTrackObjects.map(t => t.track.uri);
              const batchSize = 100;
              
              for (let i = 0; i < uris.length; i += batchSize) {
                const batch = uris.slice(i, i + batchSize);
                await fetch(`https://api.spotify.com/v1/playlists/${playlist.id}/tracks`, {
                  method: 'POST',
                  headers: {
                    'Authorization': `Bearer ${spotifyToken}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ uris: batch })
                });
                setProgress({ current: Math.min(i + batchSize, uris.length), total: uris.length });
              }
              
              setCreatedPlaylistUrl(playlist.external_urls.spotify);
              
            } catch (error) {
              console.error('Erreur cr√©ation playlist:', error);
              alert('Erreur lors de la cr√©ation de la playlist');
              setView('tracks');
            }
          };

          const copyToClipboard = async () => {
            try {
              await navigator.clipboard.writeText(createdPlaylistUrl);
              alert('Lien copi√© !');
            } catch (err) {
              // Fallback pour Electron
              const input = document.createElement('input');
              input.value = createdPlaylistUrl;
              document.body.appendChild(input);
              input.select();
              document.execCommand('copy');
              document.body.removeChild(input);
              alert('Lien copi√© !');
            }
          };

          const filteredPlaylists = playlists.filter(p => 
            p.name.toLowerCase().includes(searchQuery.toLowerCase())
          );

          if (view === 'auth') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-green-900 via-emerald-900 to-teal-900 flex items-center justify-center p-6 no-drag">
                <div className="bg-white/10 backdrop-blur-lg rounded-3xl p-12 shadow-2xl max-w-md w-full text-center">
                  <div className="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6">
                    <Music className="w-10 h-10 text-white" />
                  </div>
                  <h1 className="text-3xl font-bold text-white mb-3">Spotify Playlist Manager</h1>
                  <p className="text-white/70 mb-8">
                    Cr√©ez de nouvelles playlists √† partir de vos morceaux favoris
                  </p>
                  <button
                    onClick={connectSpotify}
                    disabled={!config.clientId}
                    className="w-full bg-green-500 hover:bg-green-600 disabled:bg-gray-500 disabled:cursor-not-allowed text-white font-semibold py-4 px-6 rounded-xl transition-all shadow-lg"
                  >
                    {config.clientId ? 'Se connecter avec Spotify' : 'Chargement...'}
                  </button>
                </div>
              </div>
            );
          }

          if (view === 'playlists') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-green-900 via-emerald-900 to-teal-900 p-6 no-drag">
                <div className="max-w-6xl mx-auto">
                  <div className="bg-white/10 backdrop-blur-lg rounded-3xl p-8 shadow-2xl">
                    <div className="flex items-center justify-between mb-8">
                      <div>
                        <h1 className="text-3xl font-bold text-white mb-2">Mes Playlists</h1>
                        <p className="text-white/70">Connect√© en tant que {spotifyUser?.display_name}</p>
                      </div>
                      <div className="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
                        <Music className="w-6 h-6 text-white" />
                      </div>
                    </div>

                    <div className="mb-6 relative">
                      <Search className="absolute left-4 top-1/2 transform -translate-y-1/2 text-white/50 w-5 h-5" />
                      <input
                        type="text"
                        placeholder="Rechercher une playlist..."
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        className="w-full bg-white/5 border border-white/20 rounded-xl pl-12 pr-4 py-3 text-white placeholder-white/50"
                      />
                    </div>

                    {loading ? (
                      <div className="flex items-center justify-center py-12">
                        <Loader className="w-8 h-8 text-white animate-spin" />
                      </div>
                    ) : (
                      <div className="grid gap-3 max-h-[600px] overflow-y-auto">
                        {filteredPlaylists.map(playlist => (
                          <button
                            key={playlist.id}
                            onClick={() => selectPlaylist(playlist)}
                            className="bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl p-4 transition-all text-left flex items-center gap-4 group"
                          >
                            {playlist.images[0] ? (
                              <img src={playlist.images[0].url} alt="" className="w-16 h-16 rounded-lg" />
                            ) : (
                              <div className="w-16 h-16 bg-green-500/20 rounded-lg flex items-center justify-center">
                                <Music className="w-8 h-8 text-green-400" />
                              </div>
                            )}
                            <div className="flex-1">
                              <h3 className="text-white font-semibold mb-1">{playlist.name}</h3>
                              <p className="text-white/60 text-sm">{playlist.tracks.total} pistes</p>
                            </div>
                            <ChevronRight className="w-5 h-5 text-white/50 group-hover:text-white transition-colors" />
                          </button>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            );
          }

          if (view === 'tracks') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-green-900 via-emerald-900 to-teal-900 p-6 no-drag">
                <div className="max-w-6xl mx-auto">
                  <div className="bg-white/10 backdrop-blur-lg rounded-3xl p-8 shadow-2xl">
                    <div className="flex items-center justify-between mb-6">
                      <div>
                        <button
                          onClick={() => setView('playlists')}
                          className="text-white/70 hover:text-white mb-2 text-sm"
                        >
                          ‚Üê Retour aux playlists
                        </button>
                        <h1 className="text-3xl font-bold text-white">{selectedPlaylist?.name}</h1>
                        <p className="text-white/70">{tracks.length} pistes disponibles</p>
                      </div>
                    </div>

                    <div className="bg-white/5 rounded-xl p-4 mb-6 flex items-center justify-between">
                      <div className="flex items-center gap-4">
                        <button
                          onClick={toggleAllTracks}
                          className="text-white hover:text-green-400 transition-colors flex items-center gap-2"
                        >
                          {selectedTracks.size === tracks.length ? (
                            <CheckSquare className="w-5 h-5" />
                          ) : (
                            <Square className="w-5 h-5" />
                          )}
                          {selectedTracks.size === tracks.length ? 'Tout d√©s√©lectionner' : 'Tout s√©lectionner'}
                        </button>
                        <span className="text-white/70">
                          {selectedTracks.size} piste{selectedTracks.size > 1 ? 's' : ''} s√©lectionn√©e{selectedTracks.size > 1 ? 's' : ''}
                        </span>
                      </div>
                      <button
                        onClick={() => selectedTracks.size > 0 && setView('creating')}
                        disabled={selectedTracks.size === 0}
                        className="bg-green-500 hover:bg-green-600 disabled:bg-gray-500 disabled:cursor-not-allowed text-white font-semibold px-6 py-2 rounded-lg transition-all"
                      >
                        Cr√©er playlist ({selectedTracks.size})
                      </button>
                    </div>

                    {loading ? (
                      <div className="flex items-center justify-center py-12">
                        <Loader className="w-8 h-8 text-white animate-spin" />
                      </div>
                    ) : (
                      <div className="space-y-2 max-h-[500px] overflow-y-auto">
                        {tracks.map((item) => (
                          <div
                            key={item.track.id}
                            onClick={() => toggleTrack(item.track.id)}
                            className={`p-4 rounded-lg cursor-pointer transition-all ${
                              selectedTracks.has(item.track.id)
                                ? 'bg-green-500/20 border-2 border-green-500'
                                : 'bg-white/5 border-2 border-transparent hover:bg-white/10'
                            }`}
                          >
                            <div className="flex items-center gap-4">
                              {selectedTracks.has(item.track.id) ? (
                                <CheckSquare className="w-5 h-5 text-green-400 flex-shrink-0" />
                              ) : (
                                <Square className="w-5 h-5 text-white/50 flex-shrink-0" />
                              )}
                              {item.track.album?.images[0] && (
                                <img 
                                  src={item.track.album.images[0].url} 
                                  alt="" 
                                  className="w-12 h-12 rounded"
                                />
                              )}
                              <div className="flex-1 min-w-0">
                                <div className="text-white font-semibold truncate">{item.track.name}</div>
                                <div className="text-white/70 text-sm truncate">
                                  {item.track.artists.map(a => a.name).join(', ')} ‚Ä¢ {item.track.album?.name}
                                </div>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            );
          }

          if (view === 'creating') {
            if (!createdPlaylistUrl) {
              return (
                <div className="min-h-screen bg-gradient-to-br from-green-900 via-emerald-900 to-teal-900 flex items-center justify-center p-6 no-drag">
                  <div className="bg-white/10 backdrop-blur-lg rounded-3xl p-12 shadow-2xl max-w-md w-full">
                    <h2 className="text-2xl font-bold text-white mb-6 text-center">Cr√©ation de la playlist</h2>
                    
                    <div className="mb-6">
                      <label className="block text-white/90 mb-2 text-sm">Nom de la playlist</label>
                      <input
                        type="text"
                        value={newPlaylistName}
                        onChange={(e) => setNewPlaylistName(e.target.value)}
                        className="w-full bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-white"
                      />
                    </div>

                    <div className="mb-8">
                      <label className="flex items-center gap-3 cursor-pointer text-white">
                        <input
                          type="checkbox"
                          checked={isPublic}
                          onChange={(e) => setIsPublic(e.target.checked)}
                          className="w-5 h-5"
                        />
                        <span>Playlist publique</span>
                      </label>
                    </div>

                    {progress.total > 0 && (
                      <div className="mb-6">
                        <div className="flex justify-between text-white/70 text-sm mb-2">
                          <span>Ajout des pistes...</span>
                          <span>{progress.current} / {progress.total}</span>
                        </div>
                        <div className="w-full bg-white/10 rounded-full h-2">
                          <div 
                            className="bg-green-500 h-2 rounded-full transition-all"
                            style={{ width: `${(progress.current / progress.total) * 100}%` }}
                          />
                        </div>
                      </div>
                    )}

                    <div className="flex gap-3">
                      <button
                        onClick={() => setView('tracks')}
                        className="flex-1 bg-white/10 hover:bg-white/20 text-white font-semibold py-3 px-6 rounded-lg transition-all"
                      >
                        Annuler
                      </button>
                      <button
                        onClick={createNewPlaylist}
                        disabled={progress.total > 0}
                        className="flex-1 bg-green-500 hover:bg-green-600 disabled:bg-gray-500 text-white font-semibold py-3 px-6 rounded-lg transition-all"
                      >
                        {progress.total > 0 ? 'Cr√©ation...' : 'Cr√©er'}
                      </button>
                    </div>
                  </div>
                </div>
              );
            }

            return (
              <div className="min-h-screen bg-gradient-to-br from-green-900 via-emerald-900 to-teal-900 flex items-center justify-center p-6 no-drag">
                <div className="bg-white/10 backdrop-blur-lg rounded-3xl p-12 shadow-2xl max-w-md w-full text-center">
                  <div className="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6">
                    <Music className="w-10 h-10 text-white" />
                  </div>
                  <h2 className="text-3xl font-bold text-white mb-3">Playlist cr√©√©e ! üéâ</h2>
                  <p className="text-white/70 mb-8">
                    Votre playlist "{newPlaylistName}" contient {selectedTracks.size} piste{selectedTracks.size > 1 ? 's' : ''}
                  </p>

                  <div className="bg-white/5 rounded-xl p-4 mb-6 break-all text-white/90 text-sm">
                    {createdPlaylistUrl}
                  </div>

                  <div className="flex gap-3">
                    <button
                      onClick={copyToClipboard}
                      className="flex-1 bg-white/10 hover:bg-white/20 text-white font-semibold py-3 px-6 rounded-lg transition-all flex items-center justify-center gap-2"
                    >
                      <Copy className="w-5 h-5" />
                      Copier
                    </button>
                    <a
                      href={createdPlaylistUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition-all flex items-center justify-center gap-2"
                    >
                      <ExternalLink className="w-5 h-5" />
                      Ouvrir
                    </a>
                  </div>

                  <button
                    onClick={() => {
                      setView('playlists');
                      setCreatedPlaylistUrl(null);
                      setSelectedTracks(new Set());
                    }}
                    className="w-full mt-4 text-white/70 hover:text-white transition-colors"
                  >
                    Retour aux playlists
                  </button>
                </div>
              </div>
            );
          }
        };

        ReactDOM.render(<SpotifyPlaylistManager />, document.getElementById('root'));
    </script>
</body>
</html>